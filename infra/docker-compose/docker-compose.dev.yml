services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: orchestrator
      POSTGRES_PASSWORD: orchestrator
      POSTGRES_DB: orchestrator
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U orchestrator -d orchestrator"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - internal
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    command: ["redis-server", "--appendonly", "yes"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - internal
    volumes:
      - redis_data:/data

  orchestrator-api:
    build:
      context: ../..
      dockerfile: services/orchestrator-api/Dockerfile
      target: base
    working_dir: /app
    command: ["pnpm", "-C", "services/orchestrator-api", "dev"]
    environment:
      DATABASE_URL: postgres://orchestrator:orchestrator@postgres:5432/orchestrator
      REDIS_URL: redis://redis:6379
      PORT: 4100
      NODE_ENV: development
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
      STRIPE_API_KEY: ${STRIPE_API_KEY:-}
      WEBHOOK_QUEUE: webhook
      DEFAULT_QUEUE: default
      DEFAULT_TENANT_ID: 00000000-0000-0000-0000-000000000000
      DEFAULT_MAX_ATTEMPTS: 4
      AUTH_MODE: disabled
      API_MODE: all
      ORCH_IMPERSONATION_SECRET: ${ORCH_IMPERSONATION_SECRET:-dev-only-secret}
      IMPERSONATION_TTL_MINUTES: ${IMPERSONATION_TTL_MINUTES:-15}
      IMPERSONATION_HEADERS_ALLOWED: ${IMPERSONATION_HEADERS_ALLOWED:-true}
      ENABLE_TEST_ROUTES: ${ENABLE_TEST_ROUTES:-true}
      PAYLOAD_STORE_ENDPOINT: ${PAYLOAD_STORE_ENDPOINT:-}
      PAYLOAD_STORE_BUCKET: ${PAYLOAD_STORE_BUCKET:-}
      PAYLOAD_STORE_ACCESS_KEY: ${PAYLOAD_STORE_ACCESS_KEY:-}
      PAYLOAD_STORE_SECRET_KEY: ${PAYLOAD_STORE_SECRET_KEY:-}
      PAYLOAD_STORE_REGION: ${PAYLOAD_STORE_REGION:-us-east-1}
      PAYLOAD_STORE_PREFIX: ${PAYLOAD_STORE_PREFIX:-payloads}
      PAYLOAD_STORE_THRESHOLD_BYTES: ${PAYLOAD_STORE_THRESHOLD_BYTES:-20000}
      PAYLOAD_STORE_FORCE_PATH_STYLE: ${PAYLOAD_STORE_FORCE_PATH_STYLE:-false}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:4100/health',r=>process.exit(r.statusCode===200?0:1)).on('error',()=>process.exit(1))"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - internal
    ports:
      - "4100:4100"
    volumes:
      - ../..:/app

  orchestrator-worker:
    build:
      context: ../..
      dockerfile: services/orchestrator-worker/Dockerfile
      target: base
    working_dir: /app
    command: ["pnpm", "-C", "services/orchestrator-worker", "dev"]
    environment:
      DATABASE_URL: postgres://orchestrator:orchestrator@postgres:5432/orchestrator
      REDIS_URL: redis://redis:6379
      NODE_ENV: development
      RETENTION_INTERVAL_MINUTES: ${RETENTION_INTERVAL_MINUTES:-1440}
      EVENT_LOG_TTL_DAYS: ${EVENT_LOG_TTL_DAYS:-30}
      REQUEST_LOG_TTL_DAYS: ${REQUEST_LOG_TTL_DAYS:-30}
      WEBHOOK_INBOX_TTL_DAYS: ${WEBHOOK_INBOX_TTL_DAYS:-14}
      JOB_TTL_DAYS: ${JOB_TTL_DAYS:-14}
      OPERATOR_AUDIT_TTL_DAYS: ${OPERATOR_AUDIT_TTL_DAYS:-365}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - internal
    volumes:
      - ../..:/app

  operator-console:
    build:
      context: ../..
      dockerfile: services/operator-console/Dockerfile
      target: base
    working_dir: /app
    command: ["pnpm", "-C", "services/operator-console", "dev"]
    environment:
      PORT: 4102
      NODE_ENV: development
      CONTROL_PLANE_URL: http://orchestrator-api:4100
      EXEC_PLANE_URL: http://orchestrator-api:4100
      CONTROL_PLANE_TOKEN: ${CONTROL_PLANE_TOKEN:-}
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:4102/health',r=>process.exit(r.statusCode===200?0:1)).on('error',()=>process.exit(1))"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - internal
    ports:
      - "4102:4102"
    volumes:
      - ../..:/app

  orchestrator-migrate:
    image: postgres:16-alpine
    command: ["/bin/sh", "-c", "for file in /migrations/*.sql; do psql \"$$DATABASE_URL\" -f \"$$file\"; done"]
    environment:
      DATABASE_URL: postgres://orchestrator:orchestrator@postgres:5432/orchestrator
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - internal
    volumes:
      - ../migrations:/migrations:ro
    profiles: ["migrations"]

networks:
  internal:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
