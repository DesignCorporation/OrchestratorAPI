<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Orchestrator Operator Console</title>
    <style>
      :root {
        color-scheme: light;
        --bg: #f6f7fb;
        --panel: #ffffff;
        --sidebar: #f2f3f7;
        --border: #e4e7ef;
        --text: #0f172a;
        --muted: #667085;
        --accent: #111827;
        --accent-soft: #eef1f8;
        --success: #16a34a;
        --warning: #f59e0b;
        --danger: #ef4444;
        --shadow: 0 2px 8px rgba(15, 23, 42, 0.08), 0 1px 2px rgba(15, 23, 42, 0.04);
        --radius: 16px;
        --radius-sm: 12px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "IBM Plex Sans", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
        color: var(--text);
        background: linear-gradient(180deg, #f7f8fc 0%, #f3f4f8 100%);
      }

      a {
        text-decoration: none;
        color: inherit;
      }

      .app {
        display: grid;
        grid-template-columns: 260px 1fr;
        min-height: 100vh;
      }

      .sidebar {
        background: var(--sidebar);
        border-right: 1px solid var(--border);
        padding: 24px 18px;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 600;
        font-size: 18px;
      }

      .brand-badge {
        width: 34px;
        height: 34px;
        border-radius: 10px;
        background: var(--accent);
        color: #fff;
        display: grid;
        place-items: center;
        font-weight: 700;
      }

      .nav {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .nav a {
        padding: 10px 12px;
        border-radius: 10px;
        color: var(--muted);
        font-size: 14px;
      }

      .nav a:hover,
      .nav a.active {
        background: #ffffff;
        color: var(--text);
        box-shadow: var(--shadow);
      }

      .sidebar-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .sidebar-label {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #98a2b3;
      }

      .sidebar-footer {
        margin-top: auto;
        display: flex;
        flex-direction: column;
        gap: 14px;
        font-size: 13px;
        color: var(--muted);
      }

      .content {
        padding: 28px 32px 40px;
      }

      .topbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        margin-bottom: 24px;
      }

      .topbar h1 {
        margin: 0;
        font-size: 24px;
        font-weight: 600;
      }

      .topbar p {
        margin: 4px 0 0;
        color: var(--muted);
      }

      .top-actions {
        display: flex;
        gap: 12px;
        align-items: center;
      }

      .workspace-switch {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px 12px;
        min-width: 200px;
      }

      .workspace-switch label {
        display: block;
        font-size: 11px;
        color: var(--muted);
        margin-bottom: 4px;
      }

      .workspace-switch select {
        width: 100%;
        border: 0;
        font-size: 14px;
        background: transparent;
        outline: none;
        color: var(--text);
      }

      .grid {
        display: grid;
        gap: 20px;
      }

      .grid-2 {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }

      .grid-3 {
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }

      .card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 18px;
        box-shadow: var(--shadow);
      }

      .card h3 {
        margin: 0 0 6px;
        font-size: 16px;
      }

      .muted {
        color: var(--muted);
        font-size: 13px;
      }

      .toolbar {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 12px;
      }

      .stack {
        flex-direction: column;
        align-items: stretch;
      }

      button {
        border: 0;
        border-radius: 10px;
        padding: 10px 14px;
        font-size: 13px;
        background: var(--accent);
        color: #fff;
        cursor: pointer;
      }

      button.secondary {
        background: #ffffff;
        color: var(--text);
        border: 1px solid var(--border);
      }

      input,
      textarea {
        border-radius: 10px;
        border: 1px solid var(--border);
        padding: 10px 12px;
        font-size: 13px;
        font-family: inherit;
        background: #fff;
      }

      textarea {
        width: 100%;
        min-height: 120px;
        font-family: "IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
        font-size: 12px;
      }

      .fields {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }

      .field label {
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 6px;
      }

      .list {
        margin-top: 12px;
        display: grid;
        gap: 8px;
      }

      .list-item {
        background: #fafbff;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px 12px;
        font-size: 12px;
      }

      .status {
        margin-top: 12px;
        padding: 12px;
        border-radius: 12px;
        background: #0b1220;
        color: #e2e8f0;
        font-family: "IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
        font-size: 12px;
        max-height: 180px;
        overflow: auto;
      }

      ul#events {
        list-style: none;
        padding: 0;
        margin: 12px 0 0;
      }

      ul#events li {
        background: #f8fafc;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px 12px;
        margin-bottom: 8px;
        font-family: "IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
        font-size: 12px;
      }

      .section {
        display: grid;
        gap: 16px;
      }

      .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .pill {
        background: var(--accent-soft);
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        color: var(--muted);
      }

      @media (max-width: 1024px) {
        .app {
          grid-template-columns: 1fr;
        }
        .sidebar {
          position: sticky;
          top: 0;
          flex-direction: row;
          flex-wrap: wrap;
          border-right: none;
          border-bottom: 1px solid var(--border);
        }
      }

      @media (max-width: 768px) {
        .content {
          padding: 20px;
        }
        .topbar {
          flex-direction: column;
          align-items: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <aside class="sidebar">
        <div class="brand">
          <span class="brand-badge">O</span>
          Orchestrator
        </div>
        <nav class="nav">
          <a class="active" href="#overview">Overview</a>
          <a href="#workspaces">Workspaces</a>
          <a href="#bundle">Bundle</a>
          <a href="#happy-path">Happy Path</a>
          <a href="#configs">Configs</a>
          <a href="#policies">Policies</a>
          <a href="#connectors">Connectors</a>
          <a href="#webhooks">Webhooks</a>
          <a href="#dlq">DLQ</a>
          <a href="#audit">Audit</a>
        </nav>
        <div class="sidebar-group">
          <div class="sidebar-label">Support</div>
          <a href="#audit">Audit logs</a>
          <a href="#events">Events stream</a>
        </div>
        <div class="sidebar-footer">
          <div>Support · Changelog</div>
          <div>Erica · operator@designcorp.eu</div>
        </div>
      </aside>
      <div class="content">
        <header class="topbar">
          <div>
            <h1>Operator Console</h1>
            <p>Единая панель управления интеграциями, webhooks и надёжностью.</p>
          </div>
          <div class="top-actions">
            <div class="workspace-switch">
              <label>Workspace</label>
              <select>
                <option>buildos-dev</option>
                <option>buildos-prod</option>
                <option>beauty-dev</option>
              </select>
            </div>
          </div>
        </header>

        <section id="overview" class="section">
          <div class="section-header">
            <h2>Overview</h2>
            <span class="pill">Last 24 hours</span>
          </div>
          <div class="grid grid-3">
            <div class="card">
              <h3>Queue depth</h3>
              <div style="font-size: 28px; font-weight: 600;">12</div>
              <div class="muted">across default + webhook</div>
            </div>
            <div class="card">
              <h3>Webhooks received</h3>
              <div style="font-size: 28px; font-weight: 600;">86</div>
              <div class="muted">+12% vs вчера</div>
            </div>
            <div class="card">
              <h3>Errors</h3>
              <div style="font-size: 28px; font-weight: 600;">3</div>
              <div class="muted">last 24h</div>
            </div>
          </div>
        </section>

        <section id="workspaces" class="section">
          <div class="section-header">
            <h2>Workspaces</h2>
            <span class="pill">Invite-only</span>
          </div>
          <div class="card">
            <div class="fields">
              <div class="field">
                <label>Workspace name</label>
                <input id="ws-name" value="buildos-dev" />
              </div>
              <div class="field">
                <label>Env</label>
                <input id="ws-env" value="dev" />
              </div>
              <div class="field">
                <label>Reason</label>
                <input id="ws-reason" placeholder="reason" />
              </div>
              <div class="field">
                <label>Invite TTL (hours)</label>
                <input id="ws-invite-ttl" value="24" />
              </div>
              <div class="field">
                <label>Invite max uses</label>
                <input id="ws-invite-uses" value="1" />
              </div>
              <div class="field">
                <label>Invite base URL (optional)</label>
                <input id="ws-invite-base" placeholder="https://orch.designcorp.eu" />
              </div>
            </div>
            <div class="toolbar">
              <button id="ws-create">Create workspace</button>
              <button id="ws-load" class="secondary">Load workspaces</button>
            </div>
            <div class="list" id="ws-list"></div>
          </div>
        </section>

        <section id="bundle" class="section">
          <div class="section-header">
            <h2>Bundle</h2>
            <span class="pill">Import / Export</span>
          </div>
          <div class="card">
            <div class="fields">
              <div class="field">
                <label>Reason</label>
                <input id="bundle-reason" placeholder="reason" />
              </div>
            </div>
            <label class="muted">Bundle JSON</label>
            <textarea id="bundle-json">{\n  "policies": [],\n  "connectors": [],\n  "secret_refs": [],\n  "configs": [],\n  "config_pointers": []\n}</textarea>
            <div class="toolbar">
              <button id="bundle-export" class="secondary">Load export</button>
              <button id="bundle-import">Import bundle</button>
            </div>
          </div>
        </section>

        <section id="happy-path" class="section">
          <div class="section-header">
            <h2>Happy Path (demo)</h2>
            <span class="pill">Execute test</span>
          </div>
          <div class="grid grid-2">
            <div class="card">
              <div class="fields">
                <div class="field">
                  <label>Connector name</label>
                  <input id="connector-name" value="demo-http" />
                </div>
                <div class="field">
                  <label>Base URL</label>
                  <input id="base-url" value="https://postman-echo.com" />
                </div>
                <div class="field">
                  <label>Operation path</label>
                  <input id="operation-path" value="/post" />
                </div>
              </div>
              <div class="toolbar">
                <button id="setup-demo">Create policy + connector</button>
                <button id="run-execute" class="secondary">Run execute</button>
              </div>
            </div>
            <div class="card">
              <h3>Status</h3>
              <p class="muted">Результаты демо‑операций и ошибок.</p>
              <div class="status" id="status"></div>
            </div>
          </div>
        </section>

        <section id="configs" class="section">
          <div class="section-header">
            <h2>Configs</h2>
            <span class="pill">Versioned</span>
          </div>
          <div class="card">
            <div class="fields">
              <div class="field">
                <label>Config name</label>
                <input id="cfg-name" value="demo-config" />
              </div>
              <div class="field">
                <label>Reason</label>
                <input id="cfg-reason" placeholder="reason" />
              </div>
            </div>
            <label class="muted">Config JSON</label>
            <textarea id="cfg-json">{\n  "version": 1,\n  "feature_flags": {"demo": true}\n}</textarea>
            <div class="toolbar">
              <button id="cfg-create">Create config</button>
              <button id="cfg-load" class="secondary">Load history</button>
              <button id="cfg-active" class="secondary">Show active</button>
              <button id="cfg-rollback" class="secondary">Rollback</button>
            </div>
            <div class="list" id="cfg-list"></div>
            <div class="list" id="cfg-active-view"></div>
          </div>
        </section>

        <section id="policies" class="section">
          <div class="section-header">
            <h2>Policies</h2>
            <span class="pill">Reliability</span>
          </div>
          <div class="card">
            <div class="fields">
              <div class="field">
                <label>Policy name</label>
                <input id="policy-name" value="ui-policy" />
              </div>
              <div class="field">
                <label>Reason</label>
                <input id="policy-reason" placeholder="reason" />
              </div>
            </div>
            <label class="muted">Policy JSON</label>
            <textarea id="policy-json">{\n  "retry_json": {"max_attempts": 3, "base_ms": 250, "max_ms": 2000}\n}</textarea>
            <div class="toolbar">
              <button id="policy-create">Create policy</button>
              <button id="policy-load" class="secondary">Load policies</button>
            </div>
            <div class="list" id="policy-list"></div>
          </div>
        </section>

        <section id="connectors" class="section">
          <div class="section-header">
            <h2>Connectors</h2>
            <span class="pill">Integrations</span>
          </div>
          <div class="card">
            <div class="fields">
              <div class="field">
                <label>Name</label>
                <input id="connector-name-ui" value="ui-connector" />
              </div>
              <div class="field">
                <label>Type</label>
                <input id="connector-type" value="http" />
              </div>
              <div class="field">
                <label>Policy ID (optional)</label>
                <input id="connector-policy-id" placeholder="uuid" />
              </div>
              <div class="field">
                <label>Secret Ref ID (optional)</label>
                <input id="connector-secret-id" placeholder="uuid" />
              </div>
              <div class="field">
                <label>Reason</label>
                <input id="connector-reason" placeholder="reason" />
              </div>
            </div>
            <label class="muted">Settings JSON</label>
            <textarea id="connector-settings">{\n  "base_url": "https://postman-echo.com",\n  "method": "POST"\n}</textarea>
            <div class="toolbar">
              <button id="connector-create">Create connector</button>
              <button id="connector-load" class="secondary">Load connectors</button>
            </div>
            <div class="list" id="connector-list"></div>
          </div>
        </section>

        <section id="webhooks" class="section">
          <div class="section-header">
            <h2>Webhook Inbox</h2>
            <span class="pill">Ingress</span>
          </div>
          <div class="card">
            <div class="fields">
              <div class="field">
                <label>Limit</label>
                <input id="inbox-limit" value="50" />
              </div>
              <div class="field">
                <label>Provider</label>
                <input id="inbox-provider" placeholder="stripe" />
              </div>
              <div class="field">
                <label>Status</label>
                <input id="inbox-status" placeholder="received" />
              </div>
              <div class="field">
                <label>Event ID</label>
                <input id="inbox-event" placeholder="evt_..." />
              </div>
            </div>
            <div class="toolbar">
              <button id="inbox-load">Load inbox</button>
            </div>
            <div class="list" id="inbox-list"></div>
          </div>
        </section>

        <section id="dlq" class="section">
          <div class="section-header">
            <h2>DLQ</h2>
            <span class="pill">Recovery</span>
          </div>
          <div class="card">
            <div class="fields">
              <div class="field">
                <label>Queue</label>
                <input id="dlq-queue" value="default" />
              </div>
              <div class="field">
                <label>Job ID</label>
                <input id="dlq-job-id" placeholder="job id" />
              </div>
              <div class="field">
                <label>Reason</label>
                <input id="dlq-reason" placeholder="reason" />
              </div>
            </div>
            <div class="toolbar">
              <button id="dlq-load" class="secondary">Load DLQ</button>
              <button id="dlq-replay">Replay job</button>
              <button id="dlq-purge" class="secondary">Purge queue</button>
            </div>
            <div class="list" id="dlq-list"></div>
          </div>
        </section>

        <section id="audit" class="section">
          <div class="section-header">
            <h2>Audit</h2>
            <span class="pill">Operator actions</span>
          </div>
          <div class="card">
            <div class="fields">
              <div class="field">
                <label>Limit</label>
                <input id="audit-limit" value="50" />
              </div>
              <div class="field">
                <label>Action (optional)</label>
                <input id="audit-action" placeholder="connector.create" />
              </div>
              <div class="field">
                <label>Operator ID (optional)</label>
                <input id="audit-operator" placeholder="uuid" />
              </div>
            </div>
            <div class="toolbar">
              <button id="audit-load">Load audit logs</button>
            </div>
            <div class="list" id="audit-list"></div>
          </div>
        </section>

        <section id="events" class="section">
          <div class="section-header">
            <h2>Events</h2>
            <span class="pill">SSE stream</span>
          </div>
          <div class="card">
            <div class="toolbar">
              <button id="connect">Connect SSE</button>
              <button id="load" class="secondary">Load last 50</button>
            </div>
            <ul id="events"></ul>
          </div>
        </section>
      </div>
    </div>
    <script>
      const list = document.getElementById('events');
      const connectBtn = document.getElementById('connect');
      const loadBtn = document.getElementById('load');
      const statusBox = document.getElementById('status');
      const setupBtn = document.getElementById('setup-demo');
      const executeBtn = document.getElementById('run-execute');
      const connectorName = document.getElementById('connector-name');
      const baseUrl = document.getElementById('base-url');
      const operationPath = document.getElementById('operation-path');
      const cfgName = document.getElementById('cfg-name');
      const cfgReason = document.getElementById('cfg-reason');
      const cfgJson = document.getElementById('cfg-json');
      const cfgCreate = document.getElementById('cfg-create');
      const cfgLoad = document.getElementById('cfg-load');
      const cfgActive = document.getElementById('cfg-active');
      const cfgRollback = document.getElementById('cfg-rollback');
      const cfgList = document.getElementById('cfg-list');
      const cfgActiveView = document.getElementById('cfg-active-view');
      const policyName = document.getElementById('policy-name');
      const policyReason = document.getElementById('policy-reason');
      const policyJson = document.getElementById('policy-json');
      const policyCreate = document.getElementById('policy-create');
      const policyLoad = document.getElementById('policy-load');
      const policyList = document.getElementById('policy-list');
      const connectorNameUi = document.getElementById('connector-name-ui');
      const connectorType = document.getElementById('connector-type');
      const connectorPolicyId = document.getElementById('connector-policy-id');
      const connectorSecretId = document.getElementById('connector-secret-id');
      const connectorReason = document.getElementById('connector-reason');
      const connectorSettings = document.getElementById('connector-settings');
      const connectorCreate = document.getElementById('connector-create');
      const connectorLoad = document.getElementById('connector-load');
      const connectorList = document.getElementById('connector-list');
      const auditLimit = document.getElementById('audit-limit');
      const auditAction = document.getElementById('audit-action');
      const auditOperator = document.getElementById('audit-operator');
      const auditLoad = document.getElementById('audit-load');
      const auditList = document.getElementById('audit-list');
      const wsName = document.getElementById('ws-name');
      const wsEnv = document.getElementById('ws-env');
      const wsReason = document.getElementById('ws-reason');
      const wsInviteTtl = document.getElementById('ws-invite-ttl');
      const wsInviteUses = document.getElementById('ws-invite-uses');
      const wsInviteBase = document.getElementById('ws-invite-base');
      const wsCreate = document.getElementById('ws-create');
      const wsLoad = document.getElementById('ws-load');
      const wsList = document.getElementById('ws-list');
      const bundleReason = document.getElementById('bundle-reason');
      const bundleJson = document.getElementById('bundle-json');
      const bundleExport = document.getElementById('bundle-export');
      const bundleImport = document.getElementById('bundle-import');
      const inboxLimit = document.getElementById('inbox-limit');
      const inboxProvider = document.getElementById('inbox-provider');
      const inboxStatus = document.getElementById('inbox-status');
      const inboxEvent = document.getElementById('inbox-event');
      const inboxLoad = document.getElementById('inbox-load');
      const inboxList = document.getElementById('inbox-list');
      const dlqQueue = document.getElementById('dlq-queue');
      const dlqJobId = document.getElementById('dlq-job-id');
      const dlqReason = document.getElementById('dlq-reason');
      const dlqLoad = document.getElementById('dlq-load');
      const dlqReplay = document.getElementById('dlq-replay');
      const dlqPurge = document.getElementById('dlq-purge');
      const dlqList = document.getElementById('dlq-list');
      const state = { policyId: null, connectorId: null };
      let source = null;

      function addEvent(data) {
        const li = document.createElement('li');
        li.textContent = data;
        list.prepend(li);
      }

      function logStatus(message, data) {
        const time = new Date().toISOString().slice(11, 19);
        const line = `[${time}] ${message}${data ? ' ' + JSON.stringify(data) : ''}`;
        const item = document.createElement('div');
        item.textContent = line;
        statusBox.prepend(item);
      }

      async function callApi(path, options = {}) {
        const res = await fetch(path, {
          headers: { 'content-type': 'application/json' },
          ...options
        });
        const text = await res.text();
        let payload = null;
        try {
          payload = JSON.parse(text);
        } catch (error) {
          payload = { raw: text };
        }
        if (!res.ok) {
          throw new Error(`${res.status}: ${JSON.stringify(payload)}`);
        }
        return payload;
      }

      function parseJsonInput(value) {
        if (!value || !value.trim()) return {};
        try {
          return JSON.parse(value);
        } catch (error) {
          throw new Error('invalid_json');
        }
      }

      function renderList(container, items, format) {
        container.innerHTML = '';
        items.forEach((item) => {
          const div = document.createElement('div');
          div.className = 'list-item';
          div.innerHTML = format(item);
          container.appendChild(div);
        });
      }

      connectBtn.addEventListener('click', () => {
        if (source) source.close();
        source = new EventSource('/api/events/stream');
        source.onmessage = (event) => addEvent(event.data);
        source.onerror = () => addEvent('sse error');
      });

      loadBtn.addEventListener('click', async () => {
        const res = await fetch('/api/events?limit=50');
        const json = await res.json();
        list.innerHTML = '';
        (json.events || []).forEach((event) => addEvent(JSON.stringify(event)));
      });

      setupBtn.addEventListener('click', async () => {
        try {
          const policy = await callApi('/api/policies', {
            method: 'POST',
            body: JSON.stringify({
              name: 'demo-policy',
              reason: 'demo setup',
              retry_json: { max_attempts: 3, base_ms: 300, max_ms: 2000 },
              timeout_json: { total_ms: 8000 },
              rate_limit_json: { max_requests: 20, interval_ms: 60000, scope: 'tenant' },
              circuit_breaker_json: { enabled: true, failure_threshold: 3, window_ms: 60000, open_ms: 15000 }
            })
          });
          state.policyId = policy.id;
          logStatus('policy создан', policy);

          const connector = await callApi('/api/connectors', {
            method: 'POST',
            body: JSON.stringify({
              type: 'http',
              name: connectorName.value || 'demo-http',
              reason: 'demo setup',
              policy_id: state.policyId,
              settings: {
                base_url: baseUrl.value || 'https://postman-echo.com',
                method: 'POST'
              }
            })
          });
          state.connectorId = connector.id;
          logStatus('connector создан', connector);
        } catch (error) {
          logStatus('ошибка', { error: error.message });
        }
      });

      executeBtn.addEventListener('click', async () => {
        try {
          if (!state.connectorId) {
            logStatus('нет connector_id, сначала Create policy + connector');
            return;
          }
          const result = await callApi('/api/execute', {
            method: 'POST',
            body: JSON.stringify({
              connector: { id: state.connectorId },
              operation: operationPath.value || '/post',
              input: { hello: 'world', ts: new Date().toISOString() }
            })
          });
          logStatus('execute ok', result);
        } catch (error) {
          logStatus('execute ошибка', { error: error.message });
        }
      });

      cfgCreate.addEventListener('click', async () => {
        try {
          const config = parseJsonInput(cfgJson.value);
          const res = await callApi('/api/configs', {
            method: 'POST',
            body: JSON.stringify({
              name: cfgName.value,
              reason: cfgReason.value || 'ui',
              config
            })
          });
          logStatus('config создан', res);
        } catch (error) {
          logStatus('config ошибка', { error: error.message });
        }
      });

      cfgLoad.addEventListener('click', async () => {
        try {
          const [res, active] = await Promise.all([
            callApi(`/api/configs?name=${encodeURIComponent(cfgName.value)}`),
            callApi(`/api/configs/active?name=${encodeURIComponent(cfgName.value)}`).catch(() => ({ active: null }))
          ]);
          const configs = res.configs || [];
          const activeId = active.active ? active.active.config_id : null;
          renderList(cfgList, configs, (cfg) => {
            const isActive = cfg.id === activeId;
            const badge = isActive ? '<span class="muted">(active)</span>' : '';
            return `<div><strong>${cfg.name}</strong> v${cfg.version} ${badge} <button data-id="${cfg.id}" class="secondary">Activate</button></div>`;
          });
          cfgList.querySelectorAll('button').forEach((btn) => {
            btn.addEventListener('click', async () => {
              const id = btn.getAttribute('data-id');
              try {
                const resp = await callApi('/api/configs/activate', {
                  method: 'POST',
                  body: JSON.stringify({
                    name: cfgName.value,
                    config_id: id,
                    reason: cfgReason.value || 'rollback'
                  })
                });
                logStatus('config activated', resp);
              } catch (error) {
                logStatus('activate ошибка', { error: error.message });
              }
            });
          });
        } catch (error) {
          logStatus('load configs ошибка', { error: error.message });
        }
      });

      cfgActive.addEventListener('click', async () => {
        try {
          const res = await callApi(`/api/configs/active?name=${encodeURIComponent(cfgName.value)}`);
          renderList(cfgActiveView, [res.active], (item) => {
            return `<div><strong>active</strong> v${item.version} (${item.config_id})</div>`;
          });
        } catch (error) {
          logStatus('active ошибка', { error: error.message });
        }
      });

      cfgRollback.addEventListener('click', async () => {
        try {
          const [res, active] = await Promise.all([
            callApi(`/api/configs?name=${encodeURIComponent(cfgName.value)}`),
            callApi(`/api/configs/active?name=${encodeURIComponent(cfgName.value)}`)
          ]);
          const configs = (res.configs || []).slice().sort((a, b) => b.version - a.version);
          const activeVersion = active.active?.version;
          if (!activeVersion) {
            logStatus('rollback: active config not found');
            return;
          }
          const previous = configs.find((cfg) => cfg.version < activeVersion);
          if (!previous) {
            logStatus('rollback: previous version not found');
            return;
          }
          const resp = await callApi('/api/configs/activate', {
            method: 'POST',
            body: JSON.stringify({
              name: cfgName.value,
              config_id: previous.id,
              reason: cfgReason.value || 'rollback'
            })
          });
          logStatus('rollback ok', resp);
        } catch (error) {
          logStatus('rollback ошибка', { error: error.message });
        }
      });

      policyCreate.addEventListener('click', async () => {
        try {
          const policyFields = parseJsonInput(policyJson.value);
          const res = await callApi('/api/policies', {
            method: 'POST',
            body: JSON.stringify({
              name: policyName.value,
              reason: policyReason.value || 'ui',
              ...policyFields
            })
          });
          logStatus('policy создан', res);
        } catch (error) {
          logStatus('policy ошибка', { error: error.message });
        }
      });

      policyLoad.addEventListener('click', async () => {
        try {
          const res = await callApi('/api/policies');
          renderList(policyList, res.policies || [], (policy) => {
            return `<div><strong>${policy.name}</strong> (${policy.id})</div>`;
          });
        } catch (error) {
          logStatus('load policies ошибка', { error: error.message });
        }
      });

      connectorCreate.addEventListener('click', async () => {
        try {
          const settings = parseJsonInput(connectorSettings.value);
          const res = await callApi('/api/connectors', {
            method: 'POST',
            body: JSON.stringify({
              type: connectorType.value,
              name: connectorNameUi.value,
              reason: connectorReason.value || 'ui',
              policy_id: connectorPolicyId.value || null,
              secret_ref_id: connectorSecretId.value || null,
              settings
            })
          });
          logStatus('connector создан', res);
        } catch (error) {
          logStatus('connector ошибка', { error: error.message });
        }
      });

      connectorLoad.addEventListener('click', async () => {
        try {
          const res = await callApi('/api/connectors');
          renderList(connectorList, res.connectors || [], (connector) => {
            return `<div><strong>${connector.name}</strong> (${connector.type}) <span class="muted">${connector.id}</span></div>`;
          });
        } catch (error) {
          logStatus('load connectors ошибка', { error: error.message });
        }
      });

      auditLoad.addEventListener('click', async () => {
        try {
          const params = new URLSearchParams();
          if (auditLimit.value) params.set('limit', auditLimit.value);
          if (auditAction.value) params.set('action', auditAction.value);
          if (auditOperator.value) params.set('operator_id', auditOperator.value);
          const res = await callApi(`/api/audit-logs?${params.toString()}`);
          renderList(auditList, res.audits || [], (row) => {
            return `<div><strong>${row.action}</strong> ${row.resource_type}:${row.resource_id} <span class="muted">${row.created_at}</span></div>`;
          });
        } catch (error) {
          logStatus('audit ошибка', { error: error.message });
        }
      });

      wsCreate.addEventListener('click', async () => {
        try {
          const res = await callApi('/api/workspaces', {
            method: 'POST',
            body: JSON.stringify({
              name: wsName.value,
              env: wsEnv.value,
              reason: wsReason.value || 'ui'
            })
          });
          logStatus('workspace создан', res);
        } catch (error) {
          logStatus('workspace ошибка', { error: error.message });
        }
      });

      wsLoad.addEventListener('click', async () => {
        try {
          const res = await callApi('/api/workspaces');
          renderList(wsList, res.workspaces || [], (ws) => {
            return `<div><strong>${ws.name}</strong> <span class="muted">${ws.env}</span> <span class="muted">${ws.status}</span> <span class="muted">${ws.id}</span><div class="toolbar"><button data-action="invite" data-id="${ws.id}">Invite</button><button data-action="enable" data-id="${ws.id}" class="secondary">Enable</button><button data-action="disable" data-id="${ws.id}" class="secondary">Disable</button></div></div>`;
          });
          wsList.querySelectorAll('button').forEach((btn) => {
            btn.addEventListener('click', async () => {
              const id = btn.getAttribute('data-id');
              const action = btn.getAttribute('data-action');
              if (!id || !action) return;
              if (action === 'invite') {
                const payload = { reason: wsReason.value || 'ui' };
                const ttl = Number(wsInviteTtl.value);
                const uses = Number(wsInviteUses.value);
                if (Number.isFinite(ttl) && ttl > 0) payload.ttl_hours = ttl;
                if (Number.isFinite(uses) && uses > 0) payload.max_uses = uses;
                if (wsInviteBase.value) payload.base_url = wsInviteBase.value;
                try {
                  const resp = await callApi(`/api/workspaces/${id}/invite`, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                  });
                  logStatus('invite создан', resp);
                } catch (error) {
                  logStatus('invite ошибка', { error: error.message });
                }
                return;
              }
              const status = action === 'enable' ? 'active' : 'disabled';
              try {
                const resp = await callApi(`/api/workspaces/${id}`, {
                  method: 'PATCH',
                  body: JSON.stringify({
                    status,
                    reason: wsReason.value || 'ui'
                  })
                });
                logStatus('workspace updated', resp);
              } catch (error) {
                logStatus('workspace update ошибка', { error: error.message });
              }
            });
          });
        } catch (error) {
          logStatus('load workspaces ошибка', { error: error.message });
        }
      });

      bundleExport.addEventListener('click', async () => {
        try {
          const res = await callApi('/api/bundle/export');
          bundleJson.value = JSON.stringify(res, null, 2);
          logStatus('bundle export ok');
        } catch (error) {
          logStatus('bundle export ошибка', { error: error.message });
        }
      });

      bundleImport.addEventListener('click', async () => {
        try {
          const payload = parseJsonInput(bundleJson.value);
          payload.reason = bundleReason.value || 'ui';
          const res = await callApi('/api/bundle/import', {
            method: 'POST',
            body: JSON.stringify(payload)
          });
          logStatus('bundle import ok', res);
        } catch (error) {
          logStatus('bundle import ошибка', { error: error.message });
        }
      });

      inboxLoad.addEventListener('click', async () => {
        try {
          const params = new URLSearchParams();
          if (inboxLimit.value) params.set('limit', inboxLimit.value);
          if (inboxProvider.value) params.set('provider', inboxProvider.value);
          if (inboxStatus.value) params.set('status', inboxStatus.value);
          if (inboxEvent.value) params.set('event_id', inboxEvent.value);
          const res = await callApi(`/api/webhook-inbox?${params.toString()}`);
          renderList(inboxList, res.inbox || [], (row) => {
            return `<div><strong>${row.provider}</strong> ${row.event_id} <span class="muted">${row.status}</span> <span class="muted">${row.received_at}</span></div>`;
          });
        } catch (error) {
          logStatus('webhook inbox ошибка', { error: error.message });
        }
      });

      dlqLoad.addEventListener('click', async () => {
        try {
          const res = await callApi('/api/dlq');
          renderList(dlqList, res.queues || [], (queue) => {
            const jobs = (queue.jobs || []).map((job) => `${job.id}:${job.name}`).join(', ');
            return `<div><strong>${queue.queue}</strong> <span class="muted">${jobs || 'empty'}</span></div>`;
          });
        } catch (error) {
          logStatus('dlq load ошибка', { error: error.message });
        }
      });

      dlqReplay.addEventListener('click', async () => {
        try {
          const res = await callApi('/api/dlq/replay', {
            method: 'POST',
            body: JSON.stringify({
              queue: dlqQueue.value,
              job_id: dlqJobId.value,
              reason: dlqReason.value || 'ui'
            })
          });
          logStatus('dlq replay ok', res);
        } catch (error) {
          logStatus('dlq replay ошибка', { error: error.message });
        }
      });

      dlqPurge.addEventListener('click', async () => {
        try {
          const res = await callApi('/api/dlq/purge', {
            method: 'POST',
            body: JSON.stringify({
              queue: dlqQueue.value,
              reason: dlqReason.value || 'ui'
            })
          });
          logStatus('dlq purge ok', res);
        } catch (error) {
          logStatus('dlq purge ошибка', { error: error.message });
        }
      });
    </script>
  </body>
</html>
