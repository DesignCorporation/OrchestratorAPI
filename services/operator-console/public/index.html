<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Orchestrator Operator Console</title>
    <style>
      :root {
        color-scheme: light;
        --bg: #f6f7fb;
        --panel: #ffffff;
        --sidebar: #f2f3f7;
        --border: #e4e7ef;
        --text: #0f172a;
        --muted: #667085;
        --accent: #111827;
        --accent-soft: #eef1f8;
        --shadow: 0 2px 8px rgba(15, 23, 42, 0.08), 0 1px 2px rgba(15, 23, 42, 0.04);
        --radius: 16px;
        --radius-sm: 12px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "IBM Plex Sans", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
        color: var(--text);
        background: linear-gradient(180deg, #f7f8fc 0%, #f3f4f8 100%);
      }

      a {
        text-decoration: none;
        color: inherit;
      }

      .app {
        display: grid;
        grid-template-columns: 240px 1fr 360px;
        min-height: 100vh;
      }

      .sidebar {
        background: var(--sidebar);
        border-right: 1px solid var(--border);
        padding: 20px 18px;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
        font-size: 16px;
      }

      .brand-badge {
        width: 30px;
        height: 30px;
        border-radius: 8px;
        background: var(--accent);
        color: #fff;
        display: grid;
        place-items: center;
        font-weight: 700;
      }

      .menu {
        display: grid;
        gap: 8px;
        font-size: 13px;
      }

      .menu button {
        border: 1px solid var(--border);
        background: #fff;
        padding: 10px 12px;
        border-radius: 10px;
        cursor: pointer;
        text-align: left;
      }

      .sidebar-footer {
        margin-top: auto;
        font-size: 12px;
        color: var(--muted);
      }

      .content {
        padding: 18px 20px 24px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .topbar h1 {
        margin: 0;
        font-size: 20px;
      }

      .topbar p {
        margin: 4px 0 0;
        color: var(--muted);
        font-size: 13px;
      }

      .workspace-switch {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px 12px;
        min-width: 220px;
      }

      .workspace-switch label {
        display: block;
        font-size: 11px;
        color: var(--muted);
        margin-bottom: 4px;
      }

      .workspace-switch select {
        width: 100%;
        border: 0;
        font-size: 14px;
        background: transparent;
        outline: none;
        color: var(--text);
      }

      .canvas {
        position: relative;
        flex: 1;
        background: #fff;
        border: 1px dashed #d8dbe7;
        border-radius: var(--radius);
        min-height: 620px;
        overflow: hidden;
      }

      .canvas::before {
        content: "";
        position: absolute;
        inset: 0;
        background-image: radial-gradient(#e6e9f2 1px, transparent 1px);
        background-size: 16px 16px;
        opacity: 0.8;
      }

      .edges {
        position: absolute;
        inset: 0;
        pointer-events: none;
      }

      .node {
        position: absolute;
        min-width: 180px;
        padding: 12px;
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: var(--shadow);
        cursor: grab;
      }

      .node.selected {
        outline: 2px solid #6366f1;
      }

      .node-title {
        font-weight: 600;
        font-size: 13px;
        margin-bottom: 6px;
      }

      .node-meta {
        font-size: 12px;
        color: var(--muted);
      }

      .port {
        width: 12px;
        height: 12px;
        border-radius: 999px;
        border: 2px solid #c7cfe4;
        background: #fff;
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
      }

      .port.out {
        right: -8px;
      }

      .port.in {
        left: -8px;
      }

      .port.active {
        border-color: #6366f1;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15);
      }

      .inspector {
        background: var(--sidebar);
        border-left: 1px solid var(--border);
        padding: 20px;
        overflow: auto;
      }

      .inspector h3 {
        margin: 0 0 8px;
        font-size: 16px;
      }

      .field {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 12px;
      }

      label {
        font-size: 12px;
        color: var(--muted);
      }

      input,
      textarea,
      select {
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px 12px;
        font-size: 13px;
        font-family: inherit;
      }

      textarea {
        min-height: 110px;
        font-family: "IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      }

      .toolbar {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 12px;
      }

      button {
        border: 0;
        border-radius: 10px;
        padding: 10px 14px;
        font-size: 13px;
        background: var(--accent);
        color: #fff;
        cursor: pointer;
      }

      button.secondary {
        background: #ffffff;
        color: var(--text);
        border: 1px solid var(--border);
      }

      button.danger {
        background: #fff1f2;
        color: #b42318;
        border: 1px solid #fda4af;
      }

      .panel {
        display: none;
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 16px;
        margin-top: 16px;
        box-shadow: var(--shadow);
      }

      .panel.active {
        display: block;
      }

      .panel h4 {
        margin: 0 0 6px;
      }

      .muted {
        color: var(--muted);
        font-size: 12px;
      }

      .status {
        margin-top: 12px;
        padding: 12px;
        border-radius: 12px;
        background: #0b1220;
        color: #e2e8f0;
        font-family: "IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
        font-size: 12px;
        max-height: 180px;
        overflow: auto;
      }

      .list {
        margin-top: 12px;
        display: grid;
        gap: 8px;
      }

      .list-item {
        background: #fafbff;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px 12px;
        font-size: 12px;
      }

      .table-wrap {
        width: 100%;
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
      }

      thead th {
        text-align: left;
        color: var(--muted);
        font-weight: 600;
        padding: 10px 8px;
        border-bottom: 1px solid var(--border);
      }

      tbody td {
        padding: 10px 8px;
        border-bottom: 1px solid var(--border);
      }

      tbody tr:hover {
        background: #f8f9fc;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        background: #eef2ff;
        color: #4f46e5;
        font-size: 11px;
        font-weight: 600;
      }

      .badge.success {
        background: #ecfdf3;
        color: #027a48;
      }

      .badge.warn {
        background: #fffaeb;
        color: #b54708;
      }

      .badge.danger {
        background: #fef3f2;
        color: #b42318;
      }

      .modal {
        position: fixed;
        inset: 0;
        display: none;
        place-items: center;
        background: rgba(15, 23, 42, 0.2);
        z-index: 100;
      }

      .modal.open {
        display: grid;
      }

      .modal-card {
        background: #fff;
        border-radius: 16px;
        padding: 20px;
        width: min(420px, 92vw);
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
      }

      .modal-card h3 {
        margin: 0 0 6px;
      }

      .modal-actions {
        margin-top: 16px;
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }

      @media (max-width: 1200px) {
        .app {
          grid-template-columns: 1fr;
        }
        .sidebar {
          border-right: none;
          border-bottom: 1px solid var(--border);
        }
        .inspector {
          border-left: none;
          border-top: 1px solid var(--border);
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <aside class="sidebar">
        <div class="brand">
          <span class="brand-badge">O</span>
          Orchestrator
        </div>
        <div class="menu">
          <div class="muted" style="font-size:11px; text-transform:uppercase; letter-spacing:0.08em;">Projects</div>
          <button id="ws-list-load">Load workspaces</button>
          <div id="ws-list-mini" class="list"></div>
        </div>
        <div class="menu">
          <div class="muted" style="font-size:11px; text-transform:uppercase; letter-spacing:0.08em;">Add block</div>
          <button id="add-api">API block</button>
          <button id="add-policy">Policy block</button>
          <button id="add-webhook">Webhook block</button>
          <button id="add-workspace">Workspace block</button>
          <button id="add-config">Config block</button>
          <button id="add-dlq">DLQ block</button>
          <button id="reset" class="danger">Reset canvas</button>
        </div>
        <p class="muted">
          Слева проекты, справа — настройки выбранного блока. Канвас пустой по умолчанию.
        </p>
        <div class="sidebar-footer">
          Operator Console · buildOS
        </div>
      </aside>

      <main class="content">
        <div class="topbar">
          <div>
            <h1>Workspace Flow</h1>
            <p>Drag & connect blocks. Click a block to edit.</p>
          </div>
          <div class="workspace-switch">
            <label>Workspace</label>
            <select>
              <option>buildos-dev</option>
              <option>buildos-prod</option>
              <option>beauty-dev</option>
            </select>
          </div>
        </div>
        <div class="canvas" id="canvas">
          <svg class="edges" id="edges"></svg>
        </div>
      </main>

      <aside class="inspector">
        <h3>Node Inspector</h3>
        <div class="muted" id="inspect-empty">Select a block on the canvas.</div>
        <div id="inspect-form" style="display:none;">
          <div class="field">
            <label>Title</label>
            <input id="node-title" />
          </div>
          <div class="field">
            <label>Type</label>
            <select id="node-type">
              <option value="api">API</option>
              <option value="policy">Policy</option>
              <option value="webhook">Webhook</option>
              <option value="workspace">Workspace</option>
              <option value="config">Config</option>
              <option value="dlq">DLQ</option>
            </select>
          </div>
          <div class="field">
            <label>Endpoint / Details</label>
            <input id="node-endpoint" />
          </div>
          <div class="field">
            <label>Notes</label>
            <textarea id="node-notes"></textarea>
          </div>
        </div>

        <div id="panel-overview" class="panel active">
          <h4>Overview</h4>
          <div class="list">
            <div class="list-item"><strong>Queue depth</strong> 12</div>
            <div class="list-item"><strong>Webhooks received</strong> 86</div>
            <div class="list-item"><strong>Errors</strong> 3</div>
          </div>
        </div>

        <div id="panel-workspaces" class="panel">
          <h4>Workspaces</h4>
          <div class="field">
            <label>Workspace name</label>
            <input id="ws-name" value="buildos-dev" />
          </div>
          <div class="field">
            <label>Env</label>
            <input id="ws-env" value="dev" />
          </div>
          <div class="field">
            <label>Reason</label>
            <input id="ws-reason" placeholder="reason" />
          </div>
          <div class="field">
            <label>Invite TTL (hours)</label>
            <input id="ws-invite-ttl" value="24" />
          </div>
          <div class="field">
            <label>Invite max uses</label>
            <input id="ws-invite-uses" value="1" />
          </div>
          <div class="field">
            <label>Invite base URL (optional)</label>
            <input id="ws-invite-base" placeholder="https://orch.designcorp.eu" />
          </div>
          <div class="toolbar">
            <button id="ws-create">Create workspace</button>
            <button id="ws-load" class="secondary">Load workspaces</button>
          </div>
          <div class="list" id="ws-list"></div>
        </div>

        <div id="panel-bundle" class="panel">
          <h4>Bundle</h4>
          <div class="field">
            <label>Reason</label>
            <input id="bundle-reason" placeholder="reason" />
          </div>
          <label class="muted">Bundle JSON</label>
          <textarea id="bundle-json">{\n  "policies": [],\n  "connectors": [],\n  "secret_refs": [],\n  "configs": [],\n  "config_pointers": []\n}</textarea>
          <div class="toolbar">
            <button id="bundle-export" class="secondary">Load export</button>
            <button id="bundle-import">Import bundle</button>
          </div>
        </div>

        <div id="panel-happy-path" class="panel">
          <h4>Happy Path (demo)</h4>
          <div class="field">
            <label>Connector name</label>
            <input id="connector-name" value="demo-http" />
          </div>
          <div class="field">
            <label>Base URL</label>
            <input id="base-url" value="https://postman-echo.com" />
          </div>
          <div class="field">
            <label>Operation path</label>
            <input id="operation-path" value="/post" />
          </div>
          <div class="toolbar">
            <button id="setup-demo">Create policy + connector</button>
            <button id="run-execute" class="secondary">Run execute</button>
          </div>
          <div class="status" id="status"></div>
        </div>

        <div id="panel-configs" class="panel">
          <h4>Configs</h4>
          <div class="field">
            <label>Config name</label>
            <input id="cfg-name" value="demo-config" />
          </div>
          <div class="field">
            <label>Reason</label>
            <input id="cfg-reason" placeholder="reason" />
          </div>
          <label class="muted">Config JSON</label>
          <textarea id="cfg-json">{\n  "version": 1,\n  "feature_flags": {"demo": true}\n}</textarea>
          <div class="toolbar">
            <button id="cfg-create">Create config</button>
            <button id="cfg-load" class="secondary">Load history</button>
            <button id="cfg-active" class="secondary">Show active</button>
            <button id="cfg-rollback" class="secondary">Rollback</button>
          </div>
          <div class="list" id="cfg-list"></div>
          <div class="list" id="cfg-active-view"></div>
        </div>

        <div id="panel-policies" class="panel">
          <h4>Policies</h4>
          <div class="field">
            <label>Policy name</label>
            <input id="policy-name" value="ui-policy" />
          </div>
          <div class="field">
            <label>Reason</label>
            <input id="policy-reason" placeholder="reason" />
          </div>
          <label class="muted">Policy JSON</label>
          <textarea id="policy-json">{\n  "retry_json": {"max_attempts": 3, "base_ms": 250, "max_ms": 2000}\n}</textarea>
          <div class="toolbar">
            <button id="policy-create">Create policy</button>
            <button id="policy-load" class="secondary">Load policies</button>
          </div>
          <div class="list" id="policy-list"></div>
        </div>

        <div id="panel-connectors" class="panel">
          <h4>Connectors</h4>
          <div class="field">
            <label>Name</label>
            <input id="connector-name-ui" value="ui-connector" />
          </div>
          <div class="field">
            <label>Type</label>
            <input id="connector-type" value="http" />
          </div>
          <div class="field">
            <label>Policy ID (optional)</label>
            <input id="connector-policy-id" placeholder="uuid" />
          </div>
          <div class="field">
            <label>Secret Ref ID (optional)</label>
            <input id="connector-secret-id" placeholder="uuid" />
          </div>
          <div class="field">
            <label>Reason</label>
            <input id="connector-reason" placeholder="reason" />
          </div>
          <label class="muted">Settings JSON</label>
          <textarea id="connector-settings">{\n  "base_url": "https://postman-echo.com",\n  "method": "POST"\n}</textarea>
          <div class="toolbar">
            <button id="connector-create">Create connector</button>
            <button id="connector-load" class="secondary">Load connectors</button>
          </div>
          <div class="list" id="connector-list"></div>
        </div>

        <div id="panel-webhooks" class="panel">
          <h4>Webhook Inbox</h4>
          <div class="field">
            <label>Limit</label>
            <input id="inbox-limit" value="50" />
          </div>
          <div class="field">
            <label>Provider</label>
            <input id="inbox-provider" placeholder="stripe" />
          </div>
          <div class="field">
            <label>Status</label>
            <input id="inbox-status" placeholder="received" />
          </div>
          <div class="field">
            <label>Event ID</label>
            <input id="inbox-event" placeholder="evt_..." />
          </div>
          <div class="toolbar">
            <button id="inbox-load">Load inbox</button>
          </div>
          <div class="list" id="inbox-list"></div>
        </div>

        <div id="panel-dlq" class="panel">
          <h4>DLQ</h4>
          <div class="field">
            <label>Queue</label>
            <input id="dlq-queue" value="default" />
          </div>
          <div class="field">
            <label>Job ID</label>
            <input id="dlq-job-id" placeholder="job id" />
          </div>
          <div class="field">
            <label>Reason</label>
            <input id="dlq-reason" placeholder="reason" />
          </div>
          <div class="toolbar">
            <button id="dlq-load" class="secondary">Load DLQ</button>
            <button id="dlq-replay">Replay job</button>
            <button id="dlq-purge" class="danger">Purge queue</button>
          </div>
          <div class="list" id="dlq-list"></div>
        </div>

        <div id="panel-audit" class="panel">
          <h4>Audit</h4>
          <div class="field">
            <label>Limit</label>
            <input id="audit-limit" value="50" />
          </div>
          <div class="field">
            <label>Action (optional)</label>
            <input id="audit-action" placeholder="connector.create" />
          </div>
          <div class="field">
            <label>Operator ID (optional)</label>
            <input id="audit-operator" placeholder="uuid" />
          </div>
          <div class="toolbar">
            <button id="audit-load">Load audit logs</button>
          </div>
          <div class="list" id="audit-list"></div>
        </div>

        <div id="panel-events" class="panel">
          <h4>Events</h4>
          <div class="toolbar">
            <button id="connect">Connect SSE</button>
            <button id="load" class="secondary">Load last 50</button>
          </div>
          <ul id="events"></ul>
        </div>
      </aside>
    </div>

    <div class="modal" id="confirm-modal" role="dialog" aria-modal="true">
      <div class="modal-card">
        <h3 id="confirm-title">Confirm action</h3>
        <p class="muted" id="confirm-message">Are you sure?</p>
        <div class="modal-actions">
          <button class="secondary" id="confirm-cancel">Cancel</button>
          <button class="danger" id="confirm-accept">Confirm</button>
        </div>
      </div>
    </div>

    <script>
      const canvas = document.getElementById('canvas');
      const edgesSvg = document.getElementById('edges');
      const inspectEmpty = document.getElementById('inspect-empty');
      const inspectForm = document.getElementById('inspect-form');
      const nodeTitle = document.getElementById('node-title');
      const nodeType = document.getElementById('node-type');
      const nodeEndpoint = document.getElementById('node-endpoint');
      const nodeNotes = document.getElementById('node-notes');
      const panels = document.querySelectorAll('.panel');
      const list = document.getElementById('events');
      const connectBtn = document.getElementById('connect');
      const loadBtn = document.getElementById('load');
      const statusBox = document.getElementById('status');
      const setupBtn = document.getElementById('setup-demo');
      const executeBtn = document.getElementById('run-execute');
      const connectorName = document.getElementById('connector-name');
      const baseUrl = document.getElementById('base-url');
      const operationPath = document.getElementById('operation-path');
      const cfgName = document.getElementById('cfg-name');
      const cfgReason = document.getElementById('cfg-reason');
      const cfgJson = document.getElementById('cfg-json');
      const cfgCreate = document.getElementById('cfg-create');
      const cfgLoad = document.getElementById('cfg-load');
      const cfgActive = document.getElementById('cfg-active');
      const cfgRollback = document.getElementById('cfg-rollback');
      const cfgList = document.getElementById('cfg-list');
      const cfgActiveView = document.getElementById('cfg-active-view');
      const policyName = document.getElementById('policy-name');
      const policyReason = document.getElementById('policy-reason');
      const policyJson = document.getElementById('policy-json');
      const policyCreate = document.getElementById('policy-create');
      const policyLoad = document.getElementById('policy-load');
      const policyList = document.getElementById('policy-list');
      const connectorNameUi = document.getElementById('connector-name-ui');
      const connectorType = document.getElementById('connector-type');
      const connectorPolicyId = document.getElementById('connector-policy-id');
      const connectorSecretId = document.getElementById('connector-secret-id');
      const connectorReason = document.getElementById('connector-reason');
      const connectorSettings = document.getElementById('connector-settings');
      const connectorCreate = document.getElementById('connector-create');
      const connectorLoad = document.getElementById('connector-load');
      const connectorList = document.getElementById('connector-list');
      const auditLimit = document.getElementById('audit-limit');
      const auditAction = document.getElementById('audit-action');
      const auditOperator = document.getElementById('audit-operator');
      const auditLoad = document.getElementById('audit-load');
      const auditList = document.getElementById('audit-list');
      const wsName = document.getElementById('ws-name');
      const wsEnv = document.getElementById('ws-env');
      const wsReason = document.getElementById('ws-reason');
      const wsInviteTtl = document.getElementById('ws-invite-ttl');
      const wsInviteUses = document.getElementById('ws-invite-uses');
      const wsInviteBase = document.getElementById('ws-invite-base');
      const wsCreate = document.getElementById('ws-create');
      const wsLoad = document.getElementById('ws-load');
      const wsList = document.getElementById('ws-list');
      const wsListMini = document.getElementById('ws-list-mini');
      const wsListLoad = document.getElementById('ws-list-load');
      const bundleReason = document.getElementById('bundle-reason');
      const bundleJson = document.getElementById('bundle-json');
      const bundleExport = document.getElementById('bundle-export');
      const bundleImport = document.getElementById('bundle-import');
      const inboxLimit = document.getElementById('inbox-limit');
      const inboxProvider = document.getElementById('inbox-provider');
      const inboxStatus = document.getElementById('inbox-status');
      const inboxEvent = document.getElementById('inbox-event');
      const inboxLoad = document.getElementById('inbox-load');
      const inboxList = document.getElementById('inbox-list');
      const dlqQueue = document.getElementById('dlq-queue');
      const dlqJobId = document.getElementById('dlq-job-id');
      const dlqReason = document.getElementById('dlq-reason');
      const dlqLoad = document.getElementById('dlq-load');
      const dlqReplay = document.getElementById('dlq-replay');
      const dlqPurge = document.getElementById('dlq-purge');
      const dlqList = document.getElementById('dlq-list');
      const confirmModal = document.getElementById('confirm-modal');
      const confirmTitle = document.getElementById('confirm-title');
      const confirmMessage = document.getElementById('confirm-message');
      const confirmCancel = document.getElementById('confirm-cancel');
      const confirmAccept = document.getElementById('confirm-accept');
      const nodes = [];
      const edges = [];
      let activeNode = null;
      let pendingConnection = null;
      const state = { policyId: null, connectorId: null };
      let source = null;

      function escapeHtml(value) {
        return String(value ?? '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function showPanel(panelId) {
        panels.forEach((panel) => panel.classList.remove('active'));
        const target = document.getElementById(panelId);
        if (target) target.classList.add('active');
      }

      function createNode({ title, type, endpoint, panel }) {
        const node = document.createElement('div');
        node.className = 'node';
        node.style.left = `${40 + nodes.length * 40}px`;
        node.style.top = `${40 + nodes.length * 40}px`;
        node.dataset.type = type;
        node.dataset.endpoint = endpoint || '';
        node.dataset.notes = '';
        node.dataset.panel = panel || 'panel-overview';

        node.innerHTML = `
          <div class="node-title">${title}</div>
          <div class="node-meta">${endpoint || 'no endpoint'}</div>
          <div class="port in" title="input"></div>
          <div class="port out" title="output"></div>
        `;

        node.addEventListener('mousedown', startDrag);
        node.addEventListener('click', () => selectNode(node));
        node.querySelector('.port.out').addEventListener('click', (event) => {
          event.stopPropagation();
          beginConnection(node);
        });
        node.querySelector('.port.in').addEventListener('click', (event) => {
          event.stopPropagation();
          completeConnection(node);
        });

        canvas.appendChild(node);
        nodes.push(node);
        selectNode(node);
        renderEdges();
      }

      function selectNode(node) {
        nodes.forEach((n) => n.classList.remove('selected'));
        node.classList.add('selected');
        activeNode = node;
        inspectEmpty.style.display = 'none';
        inspectForm.style.display = 'block';
        nodeTitle.value = node.querySelector('.node-title').textContent;
        nodeType.value = node.dataset.type;
        nodeEndpoint.value = node.dataset.endpoint;
        nodeNotes.value = node.dataset.notes || '';
        showPanel(node.dataset.panel);
      }

      function updateNode() {
        if (!activeNode) return;
        activeNode.dataset.type = nodeType.value;
        activeNode.dataset.endpoint = nodeEndpoint.value;
        activeNode.dataset.notes = nodeNotes.value;
        activeNode.querySelector('.node-title').textContent = nodeTitle.value;
        activeNode.querySelector('.node-meta').textContent = nodeEndpoint.value || 'no endpoint';
        renderEdges();
      }

      [nodeTitle, nodeType, nodeEndpoint, nodeNotes].forEach((el) =>
        el.addEventListener('input', updateNode)
      );

      function startDrag(event) {
        const node = event.currentTarget;
        const startX = event.clientX - node.offsetLeft;
        const startY = event.clientY - node.offsetTop;

        function onMove(e) {
          node.style.left = `${e.clientX - startX}px`;
          node.style.top = `${e.clientY - startY}px`;
          renderEdges();
        }

        function onUp() {
          document.removeEventListener('mousemove', onMove);
          document.removeEventListener('mouseup', onUp);
        }

        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
      }

      function beginConnection(node) {
        pendingConnection = node;
        node.querySelector('.port.out').classList.add('active');
      }

      function completeConnection(targetNode) {
        if (!pendingConnection || pendingConnection === targetNode) return;
        edges.push({ from: pendingConnection, to: targetNode });
        pendingConnection.querySelector('.port.out').classList.remove('active');
        pendingConnection = null;
        renderEdges();
      }

      function renderEdges() {
        const rect = canvas.getBoundingClientRect();
        edgesSvg.setAttribute('width', rect.width);
        edgesSvg.setAttribute('height', rect.height);
        edgesSvg.innerHTML = '';
        edges.forEach((edge) => {
          const from = edge.from.getBoundingClientRect();
          const to = edge.to.getBoundingClientRect();
          const startX = from.right - rect.left;
          const startY = from.top - rect.top + from.height / 2;
          const endX = to.left - rect.left;
          const endY = to.top - rect.top + to.height / 2;
          const midX = (startX + endX) / 2;
          const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
          path.setAttribute(
            'd',
            `M ${startX} ${startY} C ${midX} ${startY}, ${midX} ${endY}, ${endX} ${endY}`
          );
          path.setAttribute('fill', 'none');
          path.setAttribute('stroke', '#6366f1');
          path.setAttribute('stroke-width', '2');
          edgesSvg.appendChild(path);
        });
      }

      document.getElementById('add-api').addEventListener('click', () =>
        createNode({ title: 'API Call', type: 'api', endpoint: 'POST /execute', panel: 'panel-happy-path' })
      );
      document.getElementById('add-policy').addEventListener('click', () =>
        createNode({ title: 'Policy', type: 'policy', endpoint: 'retry + timeout', panel: 'panel-policies' })
      );
      document.getElementById('add-webhook').addEventListener('click', () =>
        createNode({ title: 'Webhook', type: 'webhook', endpoint: '/webhooks/stripe', panel: 'panel-webhooks' })
      );
      document.getElementById('add-workspace').addEventListener('click', () =>
        createNode({ title: 'Workspace', type: 'workspace', endpoint: 'buildos-dev', panel: 'panel-workspaces' })
      );
      document.getElementById('add-config').addEventListener('click', () =>
        createNode({ title: 'Config', type: 'config', endpoint: '/configs', panel: 'panel-configs' })
      );
      document.getElementById('add-dlq').addEventListener('click', () =>
        createNode({ title: 'DLQ', type: 'dlq', endpoint: '/admin/dlq', panel: 'panel-dlq' })
      );
      document.getElementById('reset').addEventListener('click', () => {
        nodes.forEach((node) => node.remove());
        nodes.length = 0;
        edges.length = 0;
        edgesSvg.innerHTML = '';
        activeNode = null;
        inspectForm.style.display = 'none';
        inspectEmpty.style.display = 'block';
        showPanel('panel-overview');
      });

      function addEvent(data) {
        const li = document.createElement('li');
        li.textContent = data;
        list.prepend(li);
      }

      function logStatus(message, data) {
        const time = new Date().toISOString().slice(11, 19);
        const line = `[${time}] ${message}${data ? ' ' + JSON.stringify(data) : ''}`;
        const item = document.createElement('div');
        item.textContent = line;
        statusBox.prepend(item);
      }

      async function callApi(path, options = {}) {
        const res = await fetch(path, {
          headers: { 'content-type': 'application/json' },
          ...options
        });
        const text = await res.text();
        let payload = null;
        try {
          payload = JSON.parse(text);
        } catch (error) {
          payload = { raw: text };
        }
        if (!res.ok) {
          throw new Error(`${res.status}: ${JSON.stringify(payload)}`);
        }
        return payload;
      }

      function parseJsonInput(value) {
        if (!value || !value.trim()) return {};
        try {
          return JSON.parse(value);
        } catch (error) {
          throw new Error('invalid_json');
        }
      }

      function renderList(container, items, format) {
        container.innerHTML = '';
        items.forEach((item) => {
          const div = document.createElement('div');
          div.className = 'list-item';
          div.innerHTML = format(item);
          container.appendChild(div);
        });
      }

      function renderTable(container, columns, rows) {
        const header = columns.map((col) => `<th>${escapeHtml(col.label)}</th>`).join('');
        const body =
          rows.length === 0
            ? `<tr><td colspan="${columns.length}"><span class="muted">empty</span></td></tr>`
            : rows
                .map(
                  (row) =>
                    `<tr>${columns
                      .map((col) => {
                        const value = col.render ? col.render(row) : escapeHtml(row[col.key]);
                        return `<td>${value}</td>`;
                      })
                      .join('')}</tr>`
                )
                .join('');
        container.innerHTML = `<div class="table-wrap"><table><thead><tr>${header}</tr></thead><tbody>${body}</tbody></table></div>`;
      }

      function confirmAction({ title, message, confirmLabel = 'Confirm' }) {
        return new Promise((resolve) => {
          confirmTitle.textContent = title;
          confirmMessage.textContent = message;
          confirmAccept.textContent = confirmLabel;
          confirmModal.classList.add('open');

          const cleanup = (result) => {
            confirmModal.classList.remove('open');
            confirmAccept.onclick = null;
            confirmCancel.onclick = null;
            resolve(result);
          };

          confirmAccept.onclick = () => cleanup(true);
          confirmCancel.onclick = () => cleanup(false);
        });
      }

      connectBtn.addEventListener('click', () => {
        if (source) source.close();
        source = new EventSource('/api/events/stream');
        source.onmessage = (event) => addEvent(event.data);
        source.onerror = () => addEvent('sse error');
      });

      loadBtn.addEventListener('click', async () => {
        const res = await fetch('/api/events?limit=50');
        const json = await res.json();
        list.innerHTML = '';
        (json.events || []).forEach((event) => addEvent(JSON.stringify(event)));
      });

      setupBtn.addEventListener('click', async () => {
        try {
          const policy = await callApi('/api/policies', {
            method: 'POST',
            body: JSON.stringify({
              name: 'demo-policy',
              reason: 'demo setup',
              retry_json: { max_attempts: 3, base_ms: 300, max_ms: 2000 },
              timeout_json: { total_ms: 8000 },
              rate_limit_json: { max_requests: 20, interval_ms: 60000, scope: 'tenant' },
              circuit_breaker_json: { enabled: true, failure_threshold: 3, window_ms: 60000, open_ms: 15000 }
            })
          });
          state.policyId = policy.id;
          logStatus('policy создан', policy);

          const connector = await callApi('/api/connectors', {
            method: 'POST',
            body: JSON.stringify({
              type: 'http',
              name: connectorName.value || 'demo-http',
              reason: 'demo setup',
              policy_id: state.policyId,
              settings: {
                base_url: baseUrl.value || 'https://postman-echo.com',
                method: 'POST'
              }
            })
          });
          state.connectorId = connector.id;
          logStatus('connector создан', connector);
        } catch (error) {
          logStatus('ошибка', { error: error.message });
        }
      });

      executeBtn.addEventListener('click', async () => {
        try {
          if (!state.connectorId) {
            logStatus('нет connector_id, сначала Create policy + connector');
            return;
          }
          const result = await callApi('/api/execute', {
            method: 'POST',
            body: JSON.stringify({
              connector: { id: state.connectorId },
              operation: operationPath.value || '/post',
              input: { hello: 'world', ts: new Date().toISOString() }
            })
          });
          logStatus('execute ok', result);
        } catch (error) {
          logStatus('execute ошибка', { error: error.message });
        }
      });

      cfgCreate.addEventListener('click', async () => {
        try {
          const config = parseJsonInput(cfgJson.value);
          const res = await callApi('/api/configs', {
            method: 'POST',
            body: JSON.stringify({
              name: cfgName.value,
              reason: cfgReason.value || 'ui',
              config
            })
          });
          logStatus('config создан', res);
        } catch (error) {
          logStatus('config ошибка', { error: error.message });
        }
      });

      cfgLoad.addEventListener('click', async () => {
        try {
          const [res, active] = await Promise.all([
            callApi(`/api/configs?name=${encodeURIComponent(cfgName.value)}`),
            callApi(`/api/configs/active?name=${encodeURIComponent(cfgName.value)}`).catch(() => ({ active: null }))
          ]);
          const configs = res.configs || [];
          const activeId = active.active ? active.active.config_id : null;
          renderTable(cfgList, [
            { key: 'name', label: 'Name' },
            { key: 'version', label: 'Version' },
            {
              key: 'id',
              label: 'Status',
              render: (cfg) => (cfg.id === activeId ? '<span class="badge success">active</span>' : '<span class="badge">idle</span>')
            },
            {
              key: 'id',
              label: 'Actions',
              render: (cfg) => `<button data-id="${cfg.id}" class="secondary">Activate</button>`
            }
          ], configs);
          cfgList.querySelectorAll('button').forEach((btn) => {
            btn.addEventListener('click', async () => {
              const id = btn.getAttribute('data-id');
              try {
                const resp = await callApi('/api/configs/activate', {
                  method: 'POST',
                  body: JSON.stringify({
                    name: cfgName.value,
                    config_id: id,
                    reason: cfgReason.value || 'rollback'
                  })
                });
                logStatus('config activated', resp);
              } catch (error) {
                logStatus('activate ошибка', { error: error.message });
              }
            });
          });
        } catch (error) {
          logStatus('load configs ошибка', { error: error.message });
        }
      });

      cfgActive.addEventListener('click', async () => {
        try {
          const res = await callApi(`/api/configs/active?name=${encodeURIComponent(cfgName.value)}`);
          renderList(cfgActiveView, [res.active], (item) => {
            return `<div><strong>active</strong> v${item.version} (${item.config_id})</div>`;
          });
        } catch (error) {
          logStatus('active ошибка', { error: error.message });
        }
      });

      cfgRollback.addEventListener('click', async () => {
        try {
          const [res, active] = await Promise.all([
            callApi(`/api/configs?name=${encodeURIComponent(cfgName.value)}`),
            callApi(`/api/configs/active?name=${encodeURIComponent(cfgName.value)}`)
          ]);
          const configs = (res.configs || []).slice().sort((a, b) => b.version - a.version);
          const activeVersion = active.active?.version;
          if (!activeVersion) {
            logStatus('rollback: active config not found');
            return;
          }
          const previous = configs.find((cfg) => cfg.version < activeVersion);
          if (!previous) {
            logStatus('rollback: previous version not found');
            return;
          }
          const resp = await callApi('/api/configs/activate', {
            method: 'POST',
            body: JSON.stringify({
              name: cfgName.value,
              config_id: previous.id,
              reason: cfgReason.value || 'rollback'
            })
          });
          logStatus('rollback ok', resp);
        } catch (error) {
          logStatus('rollback ошибка', { error: error.message });
        }
      });

      policyCreate.addEventListener('click', async () => {
        try {
          const policyFields = parseJsonInput(policyJson.value);
          const res = await callApi('/api/policies', {
            method: 'POST',
            body: JSON.stringify({
              name: policyName.value,
              reason: policyReason.value || 'ui',
              ...policyFields
            })
          });
          logStatus('policy создан', res);
        } catch (error) {
          logStatus('policy ошибка', { error: error.message });
        }
      });

      policyLoad.addEventListener('click', async () => {
        try {
          const res = await callApi('/api/policies');
          renderTable(policyList, [
            { key: 'name', label: 'Name' },
            { key: 'id', label: 'Policy ID' }
          ], res.policies || []);
        } catch (error) {
          logStatus('load policies ошибка', { error: error.message });
        }
      });

      connectorCreate.addEventListener('click', async () => {
        try {
          const settings = parseJsonInput(connectorSettings.value);
          const res = await callApi('/api/connectors', {
            method: 'POST',
            body: JSON.stringify({
              type: connectorType.value,
              name: connectorNameUi.value,
              reason: connectorReason.value || 'ui',
              policy_id: connectorPolicyId.value || null,
              secret_ref_id: connectorSecretId.value || null,
              settings
            })
          });
          logStatus('connector создан', res);
        } catch (error) {
          logStatus('connector ошибка', { error: error.message });
        }
      });

      connectorLoad.addEventListener('click', async () => {
        try {
          const res = await callApi('/api/connectors');
          renderTable(connectorList, [
            { key: 'name', label: 'Name' },
            { key: 'type', label: 'Type' },
            { key: 'status', label: 'Status', render: (row) => `<span class="badge">${escapeHtml(row.status || 'active')}</span>` },
            { key: 'id', label: 'Connector ID' }
          ], res.connectors || []);
        } catch (error) {
          logStatus('load connectors ошибка', { error: error.message });
        }
      });

      auditLoad.addEventListener('click', async () => {
        try {
          const params = new URLSearchParams();
          if (auditLimit.value) params.set('limit', auditLimit.value);
          if (auditAction.value) params.set('action', auditAction.value);
          if (auditOperator.value) params.set('operator_id', auditOperator.value);
          const res = await callApi(`/api/audit-logs?${params.toString()}`);
          renderTable(auditList, [
            { key: 'action', label: 'Action' },
            { key: 'resource_type', label: 'Resource' },
            { key: 'resource_id', label: 'Resource ID' },
            { key: 'created_at', label: 'At' }
          ], res.audits || []);
        } catch (error) {
          logStatus('audit ошибка', { error: error.message });
        }
      });

      wsCreate.addEventListener('click', async () => {
        try {
          const res = await callApi('/api/workspaces', {
            method: 'POST',
            body: JSON.stringify({
              name: wsName.value,
              env: wsEnv.value,
              reason: wsReason.value || 'ui'
            })
          });
          logStatus('workspace создан', res);
        } catch (error) {
          logStatus('workspace ошибка', { error: error.message });
        }
      });

      wsLoad.addEventListener('click', async () => {
        try {
          const res = await callApi('/api/workspaces');
          renderTable(wsList, [
            { key: 'name', label: 'Name' },
            { key: 'env', label: 'Env' },
            {
              key: 'status',
              label: 'Status',
              render: (ws) =>
                ws.status === 'active'
                  ? '<span class="badge success">active</span>'
                  : '<span class="badge danger">disabled</span>'
            },
            { key: 'id', label: 'Workspace ID' },
            {
              key: 'id',
              label: 'Actions',
              render: (ws) =>
                `<button data-action="invite" data-id="${ws.id}">Invite</button>
                 <button data-action="enable" data-id="${ws.id}" class="secondary">Enable</button>
                 <button data-action="disable" data-id="${ws.id}" class="danger">Disable</button>`
            }
          ], res.workspaces || []);
          wsList.querySelectorAll('button').forEach((btn) => {
            btn.addEventListener('click', async () => {
              const id = btn.getAttribute('data-id');
              const action = btn.getAttribute('data-action');
              if (!id || !action) return;
              if (action === 'invite') {
                const payload = { reason: wsReason.value || 'ui' };
                const ttl = Number(wsInviteTtl.value);
                const uses = Number(wsInviteUses.value);
                if (Number.isFinite(ttl) && ttl > 0) payload.ttl_hours = ttl;
                if (Number.isFinite(uses) && uses > 0) payload.max_uses = uses;
                if (wsInviteBase.value) payload.base_url = wsInviteBase.value;
                try {
                  const resp = await callApi(`/api/workspaces/${id}/invite`, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                  });
                  logStatus('invite создан', resp);
                } catch (error) {
                  logStatus('invite ошибка', { error: error.message });
                }
                return;
              }
              if (action === 'disable') {
                const ok = await confirmAction({
                  title: 'Disable workspace?',
                  message: 'Workspace будет недоступен для exec/control.',
                  confirmLabel: 'Disable'
                });
                if (!ok) return;
              }
              const status = action === 'enable' ? 'active' : 'disabled';
              try {
                const resp = await callApi(`/api/workspaces/${id}`, {
                  method: 'PATCH',
                  body: JSON.stringify({
                    status,
                    reason: wsReason.value || 'ui'
                  })
                });
                logStatus('workspace updated', resp);
              } catch (error) {
                logStatus('workspace update ошибка', { error: error.message });
              }
            });
          });
        } catch (error) {
          logStatus('load workspaces ошибка', { error: error.message });
        }
      });

      wsListLoad.addEventListener('click', async () => {
        try {
          const res = await callApi('/api/workspaces');
          renderList(wsListMini, res.workspaces || [], (ws) => {
            const status = ws.status === 'active' ? 'success' : 'danger';
            return `<div><strong>${ws.name}</strong> <span class="badge ${status}">${ws.env}</span></div>`;
          });
        } catch (error) {
          logStatus('workspace list ошибка', { error: error.message });
        }
      });

      bundleExport.addEventListener('click', async () => {
        try {
          const res = await callApi('/api/bundle/export');
          bundleJson.value = JSON.stringify(res, null, 2);
          logStatus('bundle export ok');
        } catch (error) {
          logStatus('bundle export ошибка', { error: error.message });
        }
      });

      bundleImport.addEventListener('click', async () => {
        try {
          const payload = parseJsonInput(bundleJson.value);
          payload.reason = bundleReason.value || 'ui';
          const res = await callApi('/api/bundle/import', {
            method: 'POST',
            body: JSON.stringify(payload)
          });
          logStatus('bundle import ok', res);
        } catch (error) {
          logStatus('bundle import ошибка', { error: error.message });
        }
      });

      inboxLoad.addEventListener('click', async () => {
        try {
          const params = new URLSearchParams();
          if (inboxLimit.value) params.set('limit', inboxLimit.value);
          if (inboxProvider.value) params.set('provider', inboxProvider.value);
          if (inboxStatus.value) params.set('status', inboxStatus.value);
          if (inboxEvent.value) params.set('event_id', inboxEvent.value);
          const res = await callApi(`/api/webhook-inbox?${params.toString()}`);
          renderTable(inboxList, [
            { key: 'provider', label: 'Provider' },
            { key: 'event_id', label: 'Event ID' },
            { key: 'status', label: 'Status', render: (row) => `<span class="badge">${escapeHtml(row.status)}</span>` },
            { key: 'received_at', label: 'Received' }
          ], res.inbox || []);
        } catch (error) {
          logStatus('webhook inbox ошибка', { error: error.message });
        }
      });

      dlqLoad.addEventListener('click', async () => {
        try {
          const res = await callApi('/api/dlq');
          renderTable(dlqList, [
            { key: 'queue', label: 'Queue' },
            {
              key: 'jobs',
              label: 'Jobs',
              render: (queue) => {
                const jobs = (queue.jobs || []).map((job) => `${job.id}:${job.name}`).join(', ');
                return escapeHtml(jobs || 'empty');
              }
            }
          ], res.queues || []);
        } catch (error) {
          logStatus('dlq load ошибка', { error: error.message });
        }
      });

      dlqReplay.addEventListener('click', async () => {
        try {
          const ok = await confirmAction({
            title: 'Replay job?',
            message: 'Задача будет повторно выполнена.',
            confirmLabel: 'Replay'
          });
          if (!ok) return;
          const res = await callApi('/api/dlq/replay', {
            method: 'POST',
            body: JSON.stringify({
              queue: dlqQueue.value,
              job_id: dlqJobId.value,
              reason: dlqReason.value || 'ui'
            })
          });
          logStatus('dlq replay ok', res);
        } catch (error) {
          logStatus('dlq replay ошибка', { error: error.message });
        }
      });

      dlqPurge.addEventListener('click', async () => {
        try {
          const ok = await confirmAction({
            title: 'Purge queue?',
            message: 'Все failed задачи будут удалены.',
            confirmLabel: 'Purge'
          });
          if (!ok) return;
          const res = await callApi('/api/dlq/purge', {
            method: 'POST',
            body: JSON.stringify({
              queue: dlqQueue.value,
              reason: dlqReason.value || 'ui'
            })
          });
          logStatus('dlq purge ok', res);
        } catch (error) {
          logStatus('dlq purge ошибка', { error: error.message });
        }
      });
    </script>
  </body>
</html>
