<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Orchestrator Canvas Demo</title>
    <style>
      :root {
        color-scheme: light;
        --bg: #f6f7fb;
        --panel: #ffffff;
        --sidebar: #f2f3f7;
        --border: #e4e7ef;
        --text: #0f172a;
        --muted: #667085;
        --accent: #111827;
        --accent-soft: #eef1f8;
        --shadow: 0 2px 8px rgba(15, 23, 42, 0.08), 0 1px 2px rgba(15, 23, 42, 0.04);
        --radius: 14px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "IBM Plex Sans", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
        color: var(--text);
        background: linear-gradient(180deg, #f7f8fc 0%, #f3f4f8 100%);
      }

      .app {
        display: grid;
        grid-template-columns: 240px 1fr 320px;
        min-height: 100vh;
      }

      .sidebar,
      .inspector {
        background: var(--sidebar);
        border-right: 1px solid var(--border);
        padding: 20px;
      }

      .inspector {
        border-right: none;
        border-left: 1px solid var(--border);
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
        font-size: 16px;
        margin-bottom: 18px;
      }

      .brand-badge {
        width: 30px;
        height: 30px;
        border-radius: 8px;
        background: var(--accent);
        color: #fff;
        display: grid;
        place-items: center;
        font-weight: 700;
      }

      .menu {
        display: grid;
        gap: 8px;
        font-size: 13px;
      }

      .menu button {
        border: 1px solid var(--border);
        background: #fff;
        padding: 10px 12px;
        border-radius: 10px;
        cursor: pointer;
        text-align: left;
      }

      .content {
        padding: 18px 20px 24px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .topbar h1 {
        margin: 0;
        font-size: 20px;
      }

      .toolbar {
        display: flex;
        gap: 8px;
      }

      .toolbar button {
        border: 0;
        border-radius: 10px;
        padding: 8px 12px;
        background: var(--accent);
        color: #fff;
        font-size: 12px;
        cursor: pointer;
      }

      .toolbar button.secondary {
        background: #fff;
        color: var(--text);
        border: 1px solid var(--border);
      }

      .canvas {
        position: relative;
        flex: 1;
        background: #fff;
        border: 1px dashed #d8dbe7;
        border-radius: var(--radius);
        min-height: 560px;
        overflow: hidden;
      }

      .canvas::before {
        content: "";
        position: absolute;
        inset: 0;
        background-image: radial-gradient(#e6e9f2 1px, transparent 1px);
        background-size: 16px 16px;
        opacity: 0.8;
      }

      .edges {
        position: absolute;
        inset: 0;
        pointer-events: none;
      }

      .node {
        position: absolute;
        min-width: 180px;
        padding: 12px;
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: var(--shadow);
        cursor: grab;
      }

      .node.selected {
        outline: 2px solid #6366f1;
      }

      .node-title {
        font-weight: 600;
        font-size: 13px;
        margin-bottom: 6px;
      }

      .node-meta {
        font-size: 12px;
        color: var(--muted);
      }

      .port {
        width: 12px;
        height: 12px;
        border-radius: 999px;
        border: 2px solid #c7cfe4;
        background: #fff;
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
      }

      .port.out {
        right: -8px;
      }

      .port.in {
        left: -8px;
      }

      .port.active {
        border-color: #6366f1;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15);
      }

      .inspector h3 {
        margin: 0 0 8px;
        font-size: 16px;
      }

      .field {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 12px;
      }

      label {
        font-size: 12px;
        color: var(--muted);
      }

      input,
      textarea,
      select {
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px 12px;
        font-size: 13px;
        font-family: inherit;
      }

      textarea {
        min-height: 100px;
        font-family: "IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      }

      .muted {
        color: var(--muted);
        font-size: 12px;
      }

      @media (max-width: 1100px) {
        .app {
          grid-template-columns: 1fr;
        }
        .sidebar,
        .inspector {
          border: none;
          border-bottom: 1px solid var(--border);
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <aside class="sidebar">
        <div class="brand">
          <span class="brand-badge">O</span>
          Canvas Demo
        </div>
        <div class="menu">
          <button id="add-api">Add API block</button>
          <button id="add-policy">Add Policy block</button>
          <button id="add-webhook">Add Webhook block</button>
          <button id="reset">Reset canvas</button>
        </div>
        <p class="muted" style="margin-top: 16px;">
          Это черновик для понимания workflow‑UI. Блоки можно перемещать и редактировать справа.
        </p>
      </aside>

      <main class="content">
        <div class="topbar">
          <div>
            <h1>Workspace flow</h1>
            <div class="muted">Drag & edit nodes · v0 draft</div>
          </div>
          <div class="toolbar">
            <button class="secondary" onclick="location.href='/'">Back to Console</button>
          </div>
        </div>
        <div class="canvas" id="canvas">
          <svg class="edges" id="edges"></svg>
        </div>
      </main>

      <aside class="inspector">
        <h3>Node Inspector</h3>
        <div class="muted" id="inspect-empty">Select a block on the canvas.</div>
        <div id="inspect-form" style="display:none;">
          <div class="field">
            <label>Title</label>
            <input id="node-title" />
          </div>
          <div class="field">
            <label>Type</label>
            <select id="node-type">
              <option value="api">API</option>
              <option value="policy">Policy</option>
              <option value="webhook">Webhook</option>
            </select>
          </div>
          <div class="field">
            <label>Endpoint / Details</label>
            <input id="node-endpoint" />
          </div>
          <div class="field">
            <label>Notes</label>
            <textarea id="node-notes"></textarea>
          </div>
        </div>
      </aside>
    </div>

    <script>
      const canvas = document.getElementById('canvas');
      const edgesSvg = document.getElementById('edges');
      const inspectEmpty = document.getElementById('inspect-empty');
      const inspectForm = document.getElementById('inspect-form');
      const nodeTitle = document.getElementById('node-title');
      const nodeType = document.getElementById('node-type');
      const nodeEndpoint = document.getElementById('node-endpoint');
      const nodeNotes = document.getElementById('node-notes');
      const nodes = [];
      const edges = [];
      let activeNode = null;
      let pendingConnection = null;

      function createNode({ title, type, endpoint }) {
        const node = document.createElement('div');
        node.className = 'node';
        node.style.left = `${40 + nodes.length * 40}px`;
        node.style.top = `${40 + nodes.length * 40}px`;
        node.dataset.type = type;
        node.dataset.endpoint = endpoint || '';
        node.dataset.notes = '';

        node.innerHTML = `
          <div class="node-title">${title}</div>
          <div class="node-meta">${endpoint || 'no endpoint'}</div>
          <div class="port in" title="input"></div>
          <div class="port out" title="output"></div>
        `;

        node.addEventListener('mousedown', startDrag);
        node.addEventListener('click', () => selectNode(node));
        node.querySelector('.port.out').addEventListener('click', (event) => {
          event.stopPropagation();
          beginConnection(node);
        });
        node.querySelector('.port.in').addEventListener('click', (event) => {
          event.stopPropagation();
          completeConnection(node);
        });

        canvas.appendChild(node);
        nodes.push(node);
        selectNode(node);
        renderEdges();
      }

      function selectNode(node) {
        nodes.forEach((n) => n.classList.remove('selected'));
        node.classList.add('selected');
        activeNode = node;
        inspectEmpty.style.display = 'none';
        inspectForm.style.display = 'block';
        nodeTitle.value = node.querySelector('.node-title').textContent;
        nodeType.value = node.dataset.type;
        nodeEndpoint.value = node.dataset.endpoint;
        nodeNotes.value = node.dataset.notes || '';
      }

      function updateNode() {
        if (!activeNode) return;
        activeNode.dataset.type = nodeType.value;
        activeNode.dataset.endpoint = nodeEndpoint.value;
        activeNode.dataset.notes = nodeNotes.value;
        activeNode.querySelector('.node-title').textContent = nodeTitle.value;
        activeNode.querySelector('.node-meta').textContent = nodeEndpoint.value || 'no endpoint';
        renderEdges();
      }

      [nodeTitle, nodeType, nodeEndpoint, nodeNotes].forEach((el) =>
        el.addEventListener('input', updateNode)
      );

      function startDrag(event) {
        const node = event.currentTarget;
        const startX = event.clientX - node.offsetLeft;
        const startY = event.clientY - node.offsetTop;

        function onMove(e) {
          node.style.left = `${e.clientX - startX}px`;
          node.style.top = `${e.clientY - startY}px`;
          renderEdges();
        }

        function onUp() {
          document.removeEventListener('mousemove', onMove);
          document.removeEventListener('mouseup', onUp);
        }

        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
      }

      function beginConnection(node) {
        pendingConnection = node;
        node.querySelector('.port.out').classList.add('active');
      }

      function completeConnection(targetNode) {
        if (!pendingConnection || pendingConnection === targetNode) return;
        edges.push({ from: pendingConnection, to: targetNode });
        pendingConnection.querySelector('.port.out').classList.remove('active');
        pendingConnection = null;
        renderEdges();
      }

      function renderEdges() {
        const rect = canvas.getBoundingClientRect();
        edgesSvg.setAttribute('width', rect.width);
        edgesSvg.setAttribute('height', rect.height);
        edgesSvg.innerHTML = '';
        edges.forEach((edge) => {
          const from = edge.from.getBoundingClientRect();
          const to = edge.to.getBoundingClientRect();
          const startX = from.right - rect.left;
          const startY = from.top - rect.top + from.height / 2;
          const endX = to.left - rect.left;
          const endY = to.top - rect.top + to.height / 2;
          const midX = (startX + endX) / 2;

          const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
          path.setAttribute(
            'd',
            `M ${startX} ${startY} C ${midX} ${startY}, ${midX} ${endY}, ${endX} ${endY}`
          );
          path.setAttribute('fill', 'none');
          path.setAttribute('stroke', '#6366f1');
          path.setAttribute('stroke-width', '2');
          edgesSvg.appendChild(path);
        });
      }

      document.getElementById('add-api').addEventListener('click', () =>
        createNode({ title: 'API Call', type: 'api', endpoint: 'POST /execute' })
      );
      document.getElementById('add-policy').addEventListener('click', () =>
        createNode({ title: 'Policy', type: 'policy', endpoint: 'retry + timeout' })
      );
      document.getElementById('add-webhook').addEventListener('click', () =>
        createNode({ title: 'Webhook', type: 'webhook', endpoint: '/webhooks/stripe' })
      );
      document.getElementById('reset').addEventListener('click', () => {
        nodes.forEach((node) => node.remove());
        nodes.length = 0;
        edges.length = 0;
        edgesSvg.innerHTML = '';
        activeNode = null;
        inspectForm.style.display = 'none';
        inspectEmpty.style.display = 'block';
      });
    </script>
  </body>
</html>
